# 🧠 EEG 精密アーチファクト除去ツール

このアプリケーションは、2チャンネルEEGデータ（Fp1, Fp2）から、まばたきや筋電といったアーチファクト（ノイズ）を**対話的かつ精密に検出し、除去する**ためのStreamlit製Webアプリです。

スライディングウィンドウ法を用いてEEGデータから微小区間ごとに特徴量を算出し、複数の指標を組み合わせた閾値によってアーチファクト区間を特定。その結果を視覚的に確認しながら、最適な除去基準を決定することができます。

## ✨ 主な機能

-   **精密スキャン (Sliding Window)**:
    -   EEGデータを短い時間窓（0.5秒）で、少しずつ（0.1秒ずつ）ずらしながらスキャンし、アーチファクトの兆候を精密に捉えます。
-   **多角的な特徴量計算**:
    -   各微小区間ごとに、アーチファクト検出に有効な**6つの指標**を自動で計算します。
        -   **振幅 (Amplitude)**: 突発的な大きな揺れを検出。
        -   **デルタ波パワー (δ, 1-4Hz)**: 主にまばたきを検出。
        -   **シータ波パワー (θ, 4-7Hz)**
        -   **アルファ波パワー (α, 8-13Hz)**
        -   **ベータ波パワー (β, 13-30Hz)**
        -   **ガンマ波パワー (γ, 30-50Hz)**: 主に筋電ノイズを検出。
-   **対話的な閾値設定**:
    -   6つの指標すべてに対して、独立した除去閾値をインタラクティブに設定可能。
    -   閾値を変更すると、除去される区間の数がリアルタイムで更新されます。
-   **高度な可視化**:
    -   6つの特徴量から好きな2つをX軸・Y軸に指定し、関係性を散布図で確認できます（全15通りの組み合わせを探索可能）。
-   **除去結果の視覚的検証**:
    -   閾値によって除去対象となった区間が、元の脳波形のどの部分に当たるのかを、赤色のハイライトで正確に確認できます。
-   **セキュアな利用**:
    -   Streamlit Secretsを利用したパスワード認証機能を備えています。

## 🎮 使い方

1.  **ログイン**: アプリにアクセスし、設定されたパスワードでログインします。
2.  **ファイルアップロード**: サイドバーから`XDFファイル`と`試行情報ファイル`をアップロードします。
3.  **スキャン実行**: 「🔬 アーチファクトの検出・除去」タブで、**「📈 精密スキャンを実行」**ボタンを押します。
4.  **チャンネル選択**: 解析したいチャンネル（`Fp1`または`Fp2`）を選択します。
5.  **閾値の調整**:
    -   表示された散布図を見ながら、**6つの指標の閾値**を調整します。
    -   「除去された微小区間（ウィンドウ）の数」がリアルタイムで更新されるのを確認し、最適な除去基準を探ります。
    -   X軸・Y軸のセレクトボックスを切り替えて、様々な特徴量の組み合わせを観察します。
6.  **結果の検証**:
    -   「👀 除去後の波形確認」タブに移動します。
    -   確認したい`画像ID`を選択すると、**赤くハイライトされた除去区間**が波形上に表示されます。
    -   意図通りにアーチファクトが除去されているか、また正常なデータが過剰に除去されていないかを目視で確認します。

## 💡 解析のヒント

-   **まばたきを最小限で除去したい場合**:
    1.  まずは**「振幅(µV)の上限」**の閾値を、まばたきのピークより少し低く設定します。これが最も効果的です。
    2.  次に**「デルタ波パワーの上限」**を調整して、振幅だけでは捉えきれない、ゆっくりとした揺らぎを除去します。
    3.  他の指標（α, β, γなど）の閾値は、一旦非常に大きな値に設定しておき、まばたき除去への影響を最小限に抑えます。
-   **筋電ノイズ（体の緊張など）が気になる場合**:
    -   **「ガンマ波パワーの上限」**の閾値を下げてみてください。高周波のノイズを効果的に検出できます。

## ⚙️ ローカルでの実行方法

1.  **リポジトリをクローン:**
    ```bash
    git clone <your-repository-url>
    cd <repository-directory>
    ```
2.  **必要なライブラリをインストール:**
    ```bash
    pip install -r requirements.txt
    ```
3.  **Streamlitアプリを実行:**
    ```bash
    streamlit run app.py
    ```

## ☁️ Streamlit Community Cloudへのデプロイ

1.  **GitHubリポジトリの準備:** このプロジェクトの全ファイル (`app.py`, `features.py`, `loader.py`, `preprocess.py`, `utils_plot.py`, `requirements.txt`) をGitHubリポジトリにプッシュします。
2.  **Streamlit Cloudにデプロイ:** "New app" から作成したリポジトリを選択します。
3.  **パスワード認証の設定 (Secrets):**
    -   "Advanced settings..." をクリックします。
    -   **Secrets** のテキストボックスに、アプリのパスワードをTOML形式で入力します。
        ```toml
        APP_PASSWORD = "your_secure_password_here"
        ```
    -   "Save" をクリックし、"Deploy!" を実行します。

## 🗂️ プロジェクト構成

-   `app.py`: StreamlitのUI（ユーザーインターフェース）を構築するメインファイル。
-   `loader.py`: XDFファイルとCSVファイルの読み込みを担当。
-   `preprocess.py`: フィルタリングやエポック作成などの前処理を担当。
-   `features.py`: スライディングウィンドウ法による特徴量計算を担当。
-   `utils_plot.py`: Plotlyを使った各種グラフの描画を担当。
-   `requirements.txt`: アプリの動作に必要なPythonライブラリの一覧。
